<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Feed</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #fafafa;
        }
        #app {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
        }
        .instagram-logo {
            width: 200px;
            margin: 20px auto;
            display: block;
        }
        #user-form {
            padding: 20px;
        }
        #survey-form {
            display: flex;
            flex-direction: column;
        }
        #survey-form input, #survey-form select, #survey-form button {
            margin-bottom: 10px;
            padding: 10px;
            font-size: 16px;
        }
        .post {
            border-bottom: 1px solid #efefef;
            padding-bottom: 20px;
            margin-bottom: 20px;
        }
        .post-header {
            display: flex;
            align-items: center;
            padding: 10px;
        }
        .post-header img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .post-image-container {
            position: relative;
        }
        .post-image {
            width: 100%;
            height: auto;
        }
        .like-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            background-color: rgba(0,0,0,0.3);
        }
        .like-overlay img {
            width: 80px;
            height: 80px;
        }
        .post-actions {
            padding: 10px;
        }
        .post-actions button {
            background: none;
            border: none;
            cursor: pointer;
        }
        .post-actions img {
            width: 24px;
            height: 24px;
        }
        .post-likes, .post-caption {
            padding: 0 10px;
        }
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #efefef;
        }
        .footer button {
            background: none;
            border: none;
            cursor: pointer;
        }
        .footer img {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="user-form">
           <img src="https://zzhzoe.github.io/InsWebsite/post_images/IMG_0619.PNG" alt="Instagram" class="instagram-logo">
            <form id="survey-form">
                <input type="text" id="name" placeholder="NickName" required>
                <input type="text" id="studentId" placeholder="Student ID" required>
                <select id="gender" required>
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>
                <input type="number" id="age" placeholder="Age" required>
                <button type="submit">Log In</button>
            </form>
        </div>

        <div id="posts" style="display: none;">
            <!-- Posts will be dynamically added here by JavaScript -->
        </div>

        <div id="thank-you" style="display: none;">
            <h2>Thank You for Participating!</h2>
            <p>Your responses have been recorded.</p>
        </div>

        <div class="footer" style="display: none;">
            <button><img src="https://img.icons8.com/ios/50/000000/home--v1.png" alt="Home"></button>
            <button><img src="https://img.icons8.com/ios/50/000000/search--v1.png" alt="Search"></button>
            <button><img src="https://img.icons8.com/ios/50/000000/plus-math--v1.png" alt="Add"></button>
            <button><img src="https://img.icons8.com/ios/50/000000/hearts--v1.png" alt="Likes"></button>
            <button><img src="https://img.icons8.com/ios/50/000000/user-male-circle--v1.png" alt="Profile"></button>
        </div>
    </div>

    <script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyC13M47F_4HcP5Z0KPvnPdRs7FCzfwoKus",
        authDomain: "research-project-0801.firebaseapp.com",
        projectId: "research-project-0801",
        storageBucket: "research-project-0801.appspot.com",
        messagingSenderId: "655922410105",
        appId: "1:655922410105:web:b0919370054af912261aa8",
        measurementId: "G-PX7PE1V6S3"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentPage = 'user-form';
    let userData = {};
    let postDataCache = {};
    const timeLimit = 3 * 60 * 1000; // 3 minutes in milliseconds
    let postViewStates = {};
    let timerInterval;
    let startTime;

    const baseUrl = "https://zzhzoe.github.io/InsWebsite/post_images/";
    const fixedPosts = [
        // ... (保持原有的帖子数据不变)
    ];

    const variablePosts = [
        // ... (保持原有的帖子数据不变)
    ];

    // 新增的常量
    const VISIBILITY_THRESHOLD = 50; // 50% 可见性阈值
    const MIN_VIEW_TIME = 500; // 最小查看时间阈值（毫秒）
    const UPDATE_INTERVAL = 500; // 更新间隔（毫秒）

    function showPage(pageId) {
        document.getElementById('user-form').style.display = 'none';
        document.getElementById('posts').style.display = 'none';
        document.getElementById('thank-you').style.display = 'none';
        document.querySelector('.footer').style.display = 'none';

        document.getElementById(pageId).style.display = 'block';
        if (pageId === 'posts') {
            document.querySelector('.footer').style.display = 'flex';
        }
    }

    function generatePosts() {
        const posts = fixedPosts.map(post => ({...post, id: post.username}));
        const randomVariablePost = variablePosts[Math.floor(Math.random() * variablePosts.length)];
        posts.unshift(randomVariablePost);
        return shuffleArray(posts);
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function createPostElement(post) {
        const postElement = document.createElement('div');
        postElement.className = 'post';
        postElement.dataset.postId = post.id; 
        const instagramBlue = '#00376b';

        const formattedCaption = post.caption.replace(/#(\w+)/g, `<span style="color: ${instagramBlue};">#$1</span>`);
        postElement.innerHTML = `
            <div class="post-header">
                <img src="${post.profilePic}" alt="${post.username}">
                <div>
                    <div class="post-username">${post.username}</div>
                    ${post.isAI ? '<div class="post-ai-label"><span class="info-icon">&#8505;</span> AI-generated content</div>' : ''}
                </div>
                <div class="post-options">•••</div>
            </div>
            <div class="post-image-container">
                <img class="post-image" src="${post.postImage}" alt="Post by ${post.username}">
                <div class="like-overlay">
                    <img src="https://img.icons8.com/ios-filled/50/ff0000/hearts.png" alt="Like">
                </div>
            </div>
            <div class="post-actions">
                <button class="like-button"><img src="https://img.icons8.com/ios/50/000000/hearts--v1.png" alt="Like"></button>
                <button><img src="https://img.icons8.com/ios/50/000000/comments--v1.png" alt="Comment"></button>
                <button><img src="https://img.icons8.com/ios/50/000000/sent--v1.png" alt="Share"></button>
            </div>
            <div class="post-likes">0 likes</div>
            <div class="post-caption"><strong>${post.username}</strong> ${formattedCaption}</div>
        `;

        const postImageContainer = postElement.querySelector('.post-image-container');
        let lastTap = 0;

        postImageContainer.addEventListener('click', function(e) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                likePost(post.id);
                showLikeOverlay(this);
                e.preventDefault();
            }
            lastTap = currentTime;
        });
        
        const likeButton = postElement.querySelector('.like-button');
        likeButton.addEventListener('click', function() {
            likePost(post.id);
        });
        return postElement;
    }

    function likePost(postId) {
        const post = document.querySelector(`.post[data-post-id="${postId}"]`);
        const likeButton = post.querySelector('.like-button img');
        const likesElement = post.querySelector('.post-likes');
        let likes = parseInt(likesElement.textContent);

        if (likeButton.src.includes('ios/50')) {
            likeButton.src = 'https://img.icons8.com/ios-filled/50/ff0000/hearts.png';
            likes++;
        } else {
            likeButton.src = 'https://img.icons8.com/ios/50/000000/hearts--v1.png';
            likes--;
        }

        likesElement.textContent = `${likes} likes`;

        updatePostData(postId, likes, 0); // 更新点赞数据
    }

    function showLikeOverlay(container) {
        const overlay = container.querySelector('.like-overlay');
        overlay.style.display = 'flex';
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 1500);
    }

    function loadPosts() {
        const postsContainer = document.getElementById('posts');
        postsContainer.innerHTML = '';

        const posts = generatePosts();
        posts.forEach((post) => {
            const postElement = createPostElement(post);
            postsContainer.appendChild(postElement);
        });
        
        startTime = Date.now();
        console.log('Starting timer...');
        timerInterval = setInterval(checkTimeAndSubmit, 1000);
        setInterval(updateViewTimes, UPDATE_INTERVAL);
    }

    function checkTimeAndSubmit() {
        const currentTime = Date.now();
        const elapsedTime = currentTime - startTime;
        console.log(`Elapsed time: ${elapsedTime / 1000} seconds`);

        if (elapsedTime >= timeLimit) {
            console.log('Time limit reached, submitting survey...');
            clearInterval(timerInterval);
            submitSurvey();
        }
    }

    function updateViewTimes() {
        const posts = document.querySelectorAll('.post');
        const viewportHeight = window.innerHeight;
        const currentTime = Date.now();

        posts.forEach((post, index) => {
            const postId = post.dataset.postId;
            const rect = post.getBoundingClientRect();
            
            // 计算当前帖子的顶部
            const postTop = rect.top;
            
            // 计算当前帖子的底部（包括到下一个帖子的空间）
            let postBottom;
            if (index < posts.length - 1) {
                const nextPost = posts[index + 1];
                const nextRect = nextPost.getBoundingClientRect();
                postBottom = nextRect.top;
            } else {
                postBottom = rect.bottom;
            }

            const postHeight = postBottom - postTop;
            const visibleHeight = Math.min(postBottom, viewportHeight) - Math.max(postTop, 0);
            const visiblePercentage = (visibleHeight / postHeight) * 100;

            updatePostViewState(postId, visiblePercentage, currentTime);
        });
    }

    function updatePostViewState(postId, visiblePercentage, currentTime) {
        if (visiblePercentage > VISIBILITY_THRESHOLD) {
            if (!postViewStates[postId]) {
                postViewStates[postId] = {
                    startTime: currentTime,
                    lastUpdateTime: currentTime,
                    totalViewTime: 0
                };
            } else {
                const state = postViewStates[postId];
                const viewDuration = currentTime - state.lastUpdateTime;
                state.totalViewTime += viewDuration;
                state.lastUpdateTime = currentTime;
            }
        } else if (postViewStates[postId]) {
            finalizePostView(postId, currentTime);
        }
    }

    function finalizePostView(postId, currentTime) {
        const state = postViewStates[postId];
        const finalViewDuration = currentTime - state.lastUpdateTime;
        state.totalViewTime += finalViewDuration;

        if (state.totalViewTime >= MIN_VIEW_TIME) {
            const post = document.querySelector(`.post[data-post-id="${postId}"]`);
            const likes = parseInt(post.querySelector('.post-likes').textContent);
            updatePostData(postId, likes, state.totalViewTime / 1000);
        }

        delete postViewStates[postId];
    }

    function updatePostData(postId, likes, viewTime) {
        console.log(`Updating post data for post ${postId}: likes=${likes}, viewTime=${viewTime}`);

        if (!postDataCache[postId]) {
            postDataCache[postId] = {
                id: postId,
                totalViewTime: 0,
                viewCount: 0,
                likes: likes,
                lastUpdateTime: Date.now()
            };
        }

        const postData = postDataCache[postId];

        postData.totalViewTime += viewTime;
        postData.viewCount++;
        postData.likes = likes;

        console.log(`Updated post data: `, postData);

        if (Date.now() - postData.lastUpdateTime > 10000 || postData.totalViewTime > 30) {
            console.log(`Sending update for post ${postId}`);
            sendPostDataUpdate(postId);
        }
    }

    function sendPostDataUpdate(postId) {
        const postData = postDataCache[postId];
        if (!postData) return;

        const userDocRef = db.collection('users').doc(userData.docId);

        userDocRef.get().then((doc) => {
            if (doc.exists) {
                const currentPosts = doc.data().posts || [];
                const existingPostIndex = currentPosts.findIndex(post => post.id === postData.id);

                let updatedPosts;
                const currentTime = new Date().toISOString();

                if (existingPostIndex !== -1) {
                    updatedPosts = [...currentPosts];
                    updatedPosts[existingPostIndex] = {
                        ...updatedPosts[existingPostIndex],
                        likes: postData.likes,
                        totalViewTime: (updatedPosts[existingPostIndex].totalViewTime || 0) + postData.totalViewTime,
                        viewCount: (updatedPosts[existingPostIndex].viewCount || 0) + postData.viewCount,
                        lastUpdateTime: currentTime
                    };
                } else {
                    updatedPosts = [
                        ...currentPosts,
                        {
                            id: postData.id,
                            likes: postData.likes,
                            totalViewTime: postData.totalViewTime,
                            viewCount: postData.viewCount,
                            lastUpdateTime: currentTime
                        }
                    ];
                }

                return userDocRef.update({ posts: updatedPosts });
            } else {
                console.error("User document does not exist!");
                return Promise.reject("User document does not exist");
            }
        }).then(() => {
            postData.totalViewTime = 0;
            postData.viewCount = 0;
            postData.lastUpdateTime = Date.now();
            console.log("Post data successfully updated");
        }).catch((error) => {
            console.error("Error updating post data:", error);
        });
    }

    async function submitSurvey() {
        console.log('Submitting survey...');
        clearInterval(timerInterval);
        updateViewTimes();

        const currentTime = Date.now();
        Object.keys(postViewStates).forEach(postId => {
            finalizePostView(postId, currentTime);
        });

        await Promise.all(Object.keys(postDataCache).map(sendPostDataUpdate));
        try {
            await db.collection('users').doc(userData.docId).update({
                surveyCompleted: true,
                totalTime: (Date.now() - startTime) / 1000
            });
            console.log('Survey submitted successfully');
            showPage('thank-you');
        } catch (error) {
            console.error("Error submitting survey:", error);
            alert('Error submitting data. Your responses may not have been saved.');
        }
    }

    // 初始化应用
    document.addEventListener('DOMContentLoaded', function() {
        showPage('user-form');

        document.getElementById('survey-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            userData = {
                name: document.getElementById('name').value,
                studentId: document.getElementById('studentId').value,
                gender: document.getElementById('gender').value,
                age: parseInt(document.getElementById('age').value),
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                posts: []
            };

            try {
                const docRef = await db.collection('users').add(userData);
                userData.docId = docRef.id;
                showPage('posts');
                loadPosts();
            } catch (error) {
                console.error("Error submitting data:", error);
                alert('Error logging in. Please try again.');
            }
        });
    });

    // 页面卸载时最后一次更新
    window.addEventListener('beforeunload', () => {
        const currentTime = Date.now();
        Object.keys(postViewStates).forEach(postId => {
            finalizePostView(postId, currentTime);
        });
    });

    // Console log for debugging
    console.log('JavaScript loaded and running');
    </script>
</body>
</html>
